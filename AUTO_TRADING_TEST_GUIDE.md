# 自动交易系统验证测试指南

## 概述
本指南用于验证加密货币自动交易系统的信号捕捉和自动执行功能是否正常工作。

---

## 一、系统架构说明

### 1.1 信号捕捉流程
```
实时监控 → 获取K线数据 → 15分钟趋势过滤 → 5分钟回调进场 → 生成交易信号
```

### 1.2 交易执行流程
```
交易信号 → 检查限制条件 → 下单 → 记录交易 → 持仓管理 → 自动止盈止损
```

### 1.3 核心模块
- **checkSignals()**: 多时间框架信号检测（15m + 5m）
- **executeTrade()**: 自动下单执行
- **checkPositionsAndAutoClose()**: 持仓管理和自动平仓
- **connectWebSocket()**: 实时数据推送

---

## 二、环境准备

### 2.1 获取测试网API密钥
1. 访问：https://testnet.binancefuture.com/
2. 注册账号并登录
3. 进入 API Management 创建API Key
4. 记录 API Key 和 Secret

### 2.2 测试网充值
测试网会自动提供充足的测试币，无需充值。

---

## 三、测试步骤

### 测试1：连接测试

**目标**：验证能否成功连接币安API并获取账户信息

**步骤**：
1. 打开 http://localhost:5000
2. 进入"自动交易系统"页面
3. 输入测试网API Key和Secret
4. 确保勾选"测试网"和"模拟交易"模式
5. 点击"连接API"按钮

**预期结果**：
- 连接状态显示"已连接"
- 显示账户余额（例如：10000 USDT）
- 显示可选的合约列表
- 无错误提示

**验证点**：
```
✅ API连接成功
✅ 余额获取正常
✅ 合约列表加载完成
```

---

### 测试2：信号捕捉验证

**目标**：验证系统能否正确捕捉15分钟趋势 + 5分钟回调信号

**步骤**：
1. 选择1-2个主流合约（如BTCUSDT、ETHUSDT）
2. 点击"开始监控"按钮
3. 等待1-2分钟，观察"交易信号"区域
4. 查看浏览器控制台（F12 → Console）

**预期结果**：
- 状态显示"监控中"
- WebSocket连接成功
- 开始接收K线数据
- 可能出现交易信号（取决于市场条件）

**验证点**：
```
✅ WebSocket连接建立
✅ K线数据实时更新
✅ 信号检测逻辑执行
✅ 信号格式正确（symbol、direction、time、reason等）
```

---

### 测试3：自动交易执行测试（模拟模式）

**目标**：验证自动交易功能在模拟模式下是否正常执行

**前提条件**：
- 已成功连接API
- 已开始监控
- 模拟交易模式开启
- 自动交易开关关闭

**步骤**：
1. 配置交易参数：
   - 仓位大小：10%
   - 最大持仓数：3
   - 止损百分比：0.5%
   - 每日交易限制：10
   - 分段止盈：开启（1R 50%，2R 50%）
   - 移动止损：开启（1R触发，移至保本价）

2. 开启"自动交易"开关

3. 等待交易信号或触发模拟信号：
   - 如果有真实信号，观察是否自动下单
   - 如果没有信号，可以通过以下方式模拟：
     - 等待市场出现符合条件的信号
     - 或手动触发测试信号（需要修改代码添加测试按钮）

4. 观察"交易记录"区域

**预期结果**：
- 信号出现时自动执行下单
- 交易记录中出现新记录
- 记录包含：symbol、side、type、quantity、price、time、status
- 状态显示"FILLED"

**验证点**：
```
✅ 信号触发下单
✅ 订单参数正确
✅ 记录写入成功
✅ 每日交易计数增加
```

---

### 测试4：持仓管理与分段止盈

**目标**：验证持仓管理和分段止盈功能

**前提条件**：
- 已有模拟持仓（可通过模拟下单创建）

**步骤**：
1. 查看当前持仓列表
2. 观察持仓信息：
   - 1R止盈价（entryPrice ± stopLoss）
   - 2R止盈价
   - 分段状态（r1/r2/r3）
   - 最高价/最低价
   - 移动止损价格

3. 触发止盈条件：
   - 模拟价格上涨到1R止盈价
   - 观察是否执行1R平50%
   - 模拟价格上涨到2R止盈价
   - 观察是否执行2R平剩余50%

**预期结果**：
- 达到1R时，持仓数量减少50%
- 达到2R时，持仓数量清零
- 每次止盈都有交易记录
- 盈亏计算正确

**验证点**：
```
✅ 1R止盈执行（平50%）
✅ 2R止盈执行（平剩余50%）
✅ 持仓数量正确更新
✅ 盈亏记录准确
```

---

### 测试5：移动止损验证

**目标**：验证移动止损功能

**前提条件**：
- 已有模拟持仓

**步骤**：
1. 开启"移动止损"配置
2. 配置触发条件：
   - 触发R值：1
   - 移至保本价：是

3. 模拟价格变化：
   - 多头：价格从入场价上涨到1R以上
   - 观察止损价格是否移至保本价
   - 价格回落触发止损
   - 空头：价格从入场价下跌到1R以下
   - 观察止损价格是否移至保本价
   - 价格反弹触发止损

**预期结果**：
- 达到1R时，止损价格更新为入场价（保本价）
- 价格回落时，按移动止损价格平仓
- 不会亏损本金

**验证点**：
```
✅ 达到1R触发移动止损
✅ 止损价格更新为保本价
✅ 回落触发平仓
✅ 避免本金亏损
```

---

### 测试6：反向信号平仓

**目标**：验证趋势反转时是否自动平仓

**前提条件**：
- 已有模拟持仓

**步骤**：
1. 开启"反向信号平仓"配置
2. 等待市场趋势反转（或模拟反转）
3. 观察15分钟趋势方向变化

**预期结果**：
- 15分钟趋势反转时
- 自动平仓对应方向的持仓
- 平仓原因显示"反向信号: long/short"

**验证点**：
```
✅ 趋势反转检测
✅ 反向持仓自动平仓
✅ 平仓原因明确
```

---

### 测试7：限制条件验证

**目标**：验证交易限制是否生效

**步骤**：
1. 测试持仓数量限制：
   - 设置最大持仓数为1
   - 尝试触发多个信号
   - 观察是否超过限制

2. 测试每日交易限制：
   - 设置每日交易限制为3
   - 执行3笔交易后
   - 观察第4笔是否被阻止

3. 测试时间间隔限制：
   - 系统默认5分钟内不重复交易同一方向
   - 观察短时间内重复信号是否被过滤

**预期结果**：
- 达到最大持仓数时，不再开新仓
- 达到每日交易限制时，不再下单
- 短时间内重复信号被忽略

**验证点**：
```
✅ 持仓数量限制生效
✅ 每日交易限制生效
✅ 时间间隔限制生效
```

---

### 测试8：真实交易测试（⚠️ 谨慎操作）

**⚠️ 警告：此测试涉及真实资金，请务必在测试网充分测试后再执行！**

**前提条件**：
- 测试网所有测试通过
- 充分理解策略逻辑
- 仅使用少量资金（如10 USDT）

**步骤**：
1. 关闭"模拟交易"模式
2. 确保仍在"测试网"模式
3. 设置极小的仓位（如0.1%）
4. 开启自动交易
5. 密切观察交易执行情况

**预期结果**：
- 下单成功
- 持仓正确创建
- 止损止盈正常执行

**验证点**：
```
✅ 真实下单成功
✅ API调用正常
✅ 持仓管理准确
```

---

## 四、调试技巧

### 4.1 打开浏览器控制台
按F12打开开发者工具，查看Console输出：
- WebSocket连接状态
- K线数据接收
- 信号检测结果
- 交易执行日志
- 错误信息

### 4.2 常见错误排查

**错误1：EADDRINUSE: address already in use**
```bash
# Windows查找并关闭占用5000端口的进程
netstat -ano | findstr :5000
taskkill /PID <进程ID> /F
```

**错误2：API连接失败**
- 检查API Key和Secret是否正确
- 确认IP白名单设置（如已配置）
- 检查网络连接

**错误3：WebSocket连接错误**
- 检查网络连接
- 确认选择的合约代码正确
- 查看币安服务状态

### 4.3 查看网络请求
在开发者工具的Network标签中：
- 查看API请求和响应
- 检查请求参数
- 验证响应数据

---

## 五、测试记录模板

```
测试日期：_______________
测试人员：_______________
测试环境：□ 测试网 □ 实盘（⚠️）

测试1 - API连接：□ 通过 □ 失败
备注：___________________

测试2 - 信号捕捉：□ 通过 □ 失败
备注：___________________

测试3 - 自动交易（模拟）：□ 通过 □ 失败
备注：___________________

测试4 - 分段止盈：□ 通过 □ 失败
备注：___________________

测试5 - 移动止损：□ 通过 □ 失败
备注：___________________

测试6 - 反向信号平仓：□ 通过 □ 失败
备注：___________________

测试7 - 限制条件：□ 通过 □ 失败
备注：___________________

测试8 - 真实交易（⚠️）：□ 通过 □ 失败 □ 未测试
备注：___________________

总体评价：___________________
```

---

## 六、后续优化建议

1. **添加测试信号触发器**：方便测试交易执行流程
2. **完善日志系统**：记录详细的操作日志便于排查问题
3. **添加回放功能**：使用历史数据回测验证策略
4. **增加风险控制**：更严格的资金管理和风控规则
5. **性能优化**：减少API调用频率，提升响应速度

---

## 七、注意事项

⚠️ **重要提醒**：
1. 始终在测试网充分测试后再考虑实盘
2. 实盘交易前请确保：
   - 策略经过充分回测
   - 测试网运行稳定
   - 设置合理的止损
   - 使用极小仓位开始
3. 加密货币交易存在高风险，请理性投资
4. 本系统仅供学习和研究使用
5. 作者不对任何交易损失负责

---

**祝你测试顺利！** 📈
